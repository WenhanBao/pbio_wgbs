---
title: "test_5"
author: "Wenhan Bao"
date: "5/17/2023"
output: html_document
---

1

```{r}
# Load necessary libraries
library(data.table)
library(dplyr)

# Define the directories
dir_control <- "WGBS_data_control_sch/Control"
dir_sch <- "WGBS_data_control_sch/Schizophrenia"

# Get all file names
files_control <- list.files(dir_control, full.names = TRUE)
files_sch <- list.files(dir_sch, full.names = TRUE)

# Create a function to process each file
process_file <- function(file_path) {
  # Read the file
  df <- fread(file_path) %>%
    setNames(c("chromosome", "position", "methylation", "coverage")) %>%
    as.data.frame()
  
  # Remove rows with zero coverage
  df <- df[df$coverage != 0, ]
  
  # Add beta value column
  df$beta <- df$methylation / df$coverage
  
  # Set row names
  row.names(df) <- paste(df$chromosome, df$position, sep = " : ")
  
  # Rename the beta value column
  df <- df %>%
    rename_with(~ substr(basename(file_path), 1, 10), vars(beta)) %>%
    select(starts_with(substr(basename(file_path), 1, 10)))
  
  return(df)
}


# Process all files
dfs_control <- lapply(files_control, process_file)
dfs_sch <- lapply(files_sch, process_file)

# Intersect row names and keep common rows
common_rows <- intersect(lapply(dfs_control, row.names), lapply(dfs_sch, row.names))
dfs_control <- lapply(dfs_control, function(df) df[row.names(df) %in% common_rows, ])
dfs_sch <- lapply(dfs_sch, function(df) df[row.names(df) %in% common_rows, ])

# Combine all data frames
df_combined <- do.call(cbind, c(dfs_control, dfs_sch))

# Print first 10 rows
print(head(df_combined, 10))

```


